variables:
  # Default os (docker image)
  os: ubuntu:18.04
  # Default 'reference' tag for siconos
  tag: 4.2.0
  # Default ctest model. Warning : overwritten if set in schedules variables (as we expect)
  ctest_build_model: Continuous
  # Siconos registries
  REGISTRY: gricad-registry.univ-grenoble-alpes.fr/nonsmooth/siconos

  
# This job create a docker image with all required depedencies
# for Siconos with serialization/generation option ON.
# It's based on ubuntu 18.04 and should be launched manually.
docker-build:ubuntu:
  stage: build
  image: docker
  before_script:
    - echo 'Build docker image ...'
  services:
    - docker:dind
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker build -t $REGISTRY/serialization-ubuntu:18.04 - < ci_gitlab/dockerfiles/ubuntu18.04-serialization
    - docker push $REGISTRY/serialization-ubuntu:18.04
  when: manual
  only:
    - master
  allow_failure: true
#  only:
#    variables:
#      - $CI_COMMIT_MESSAGE =~ /^\[docker-build\].*/i
      


# This job clone, build and install Siconos.
# It uses a docker image from siconos repo registry.
ubuntu_reg:install_siconos:
  image: $REGISTRY/ubuntu4siconos:18.04
  stage: build
  script:
    - "sh ci_gitlab/install_siconos.sh $os" 
  artifacts:
    paths:
      - install-siconos
  only:
  - master
  allow_failure: true

# This job clone, build and install Siconos with serialization on
# It uses a docker image from siconos repo registry.
ubuntu_reg:install_siconos_serialization:
  image: $REGISTRY/serialization-ubuntu:18.04
  stage: build
  script:
    - "sh ci_gitlab/install_siconos_with_serialization.sh $os" 
  artifacts:
    paths:
      - install-siconos
  when: manual
  only:
  - master
  allow_failure: true
  
  
make_doc:
  stage: build
  image: ubuntu:18.04
  script:
    - "sh CI/make_siconos_doc.sh"
  artifacts:
    paths:
      - build/docs/build/html
  only:
  - master
  - schedules

  

pages:

  image: python:alpine
  script:
  - pwd
  - ls
  - mv build/docs/build/html public
  artifacts:
    paths:
    - public
  dependencies:
  - make_doc
  only:
  - master

